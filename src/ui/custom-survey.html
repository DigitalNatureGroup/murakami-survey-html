<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title><?= surveyConfig.name ?></title>
<style>
  /* 基本レイアウト */
  body   { font-family: sans-serif; margin: 24px; line-height: 1.6; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
  .container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  h2     { margin-bottom: 16px; color: #2c3e50; text-align: center; }
  .item  { margin: 32px 0; }

  /* 項目ラベル（太字） */
  .item label { font-weight: bold; display: block; margin-bottom: 12px; font-size: 1.2em; color: #2c3e50; }

  /* 説明文を細く小さく */
  .item label .desc{
    font-weight: normal;
    font-size: 0.9em;
    color: #7f8c8d;
    line-height: 1.5;
    display: block;
    margin-top: 6px;
  }

  /* 星評価 */
  .rating-container {
    text-align: center;
    margin: 20px 0;
  }
  
  .rating {
    display: inline-flex;
    flex-direction: row-reverse;
    gap: 8px;
  }
  
  .rating input[type="radio"] {
    display: none;
  }
  
  .rating label {
    font-size: 32px;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .rating input[type="radio"]:checked ~ label,
  .rating label:hover,
  .rating label:hover ~ label {
    color: #f39c12;
    transform: scale(1.1);
  }
  
  .rating-text {
    margin-top: 12px;
    font-size: 1.1em;
    color: #2c3e50;
    font-weight: 500;
  }

  /* テキストエリア */
  textarea { 
    width: 100%; 
    padding: 16px; 
    border: 2px solid #e0e0e0; 
    border-radius: 12px; 
    font-size: 16px; 
    margin-top: 12px;
    min-height: 150px; 
    resize: vertical;
    transition: border-color 0.3s ease;
    font-family: inherit;
  }
  
  textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
  }

  /* ボタン類 */
  .button-container {
    text-align: center;
    margin-top: 40px;
  }
  
  button{ 
    padding: 16px 32px; 
    font-size: 1.1em; 
    margin: 0 12px; 
    cursor: pointer; 
    border: none;
    border-radius: 12px;
    transition: all 0.3s ease;
    font-weight: 600;
    min-width: 140px;
  }
  
  #submitBtn{ 
    background: linear-gradient(135deg, #27ae60, #2ecc71); 
    color: #fff; 
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
  }
  
  #submitBtn:hover{ 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
  }
  
  #resetBtn{ 
    background: linear-gradient(135deg, #e74c3c, #c0392b); 
    color: #fff; 
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
  }
  
  #resetBtn:hover{ 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
  }
  
  button:disabled{ 
    opacity: 0.6; 
    cursor: not-allowed; 
    transform: none !important;
  }

  /* 注記・文献 */
  .note{ font-size: 0.85em; color: #7f8c8d; margin-top: 32px; text-align: center; }
  
  /* ローディング表示 */
  .loading{ display: none; text-align: center; margin: 20px 0; }
  .loading.show{ display: block; }
  
  /* エラー表示 */
  .error{ color: #e74c3c; background: #fdf2f2; padding: 16px; border-radius: 12px; margin: 16px 0; border-left: 4px solid #e74c3c; }
  
  /* 成功表示 */
  .success{ color: #27ae60; background: #f0f9f0; padding: 16px; border-radius: 12px; margin: 16px 0; border-left: 4px solid #27ae60; }
  
  /* 実験情報 */
  .experiment-info {
    background: linear-gradient(135deg, #e8f4fd, #d6eaf8); 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 32px; 
    font-size: 0.9em;
    border-left: 4px solid #3498db;
    text-align: center;
  }
  
  /* アニメーション */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .item {
    animation: fadeIn 0.6s ease-out;
  }
  
  .item:nth-child(2) { animation-delay: 0.1s; }
  .item:nth-child(3) { animation-delay: 0.2s; }
</style>
</head>
<body>

<div class="container">
  <h2><?= surveyConfig.name ?></h2>

  <!-- 実験パラメータ表示 -->
  <div class="experiment-info">
    <strong>実験情報:</strong><br>
    UID: <?= uid ?><br>
    Method: <?= method ?><br>
    Session: <?= session ?>
  </div>

  <form id="surveyForm">
    <!-- 実験パラメータを隠しフィールドで保持 -->
    <input type="hidden" name="uid" value="<?= uid ?>">
    <input type="hidden" name="method" value="<?= method ?>">
    <input type="hidden" name="session" value="<?= session ?>">
    <input type="hidden" name="surveyType" value="<?= surveyType ?>">
    
    <!-- 動的にフィールドを生成 -->
    <? for (let field of surveyConfig.fields) { ?>
      <div class="item">
        <label for="<?= field.id ?>">
          <?= field.label ?>
          <? if (field.desc) { ?>
            <span class="desc"><?= field.desc ?></span>
          <? } ?>
        </label>
        
        <? if (field.type === 'rating') { ?>
          <div class="rating-container">
            <div class="rating">
              <? for (let i = 5; i >= 1; i--) { ?>
                <input type="radio" id="<?= field.id ?>_<?= i ?>" 
                       name="<?= field.id ?>" value="<?= i ?>" required>
                <label for="<?= field.id ?>_<?= i ?>">★</label>
              <? } ?>
            </div>
            <div class="rating-text" id="ratingText_<?= field.id ?>">評価を選択してください</div>
          </div>
          
        <? } else if (field.type === 'textarea') { ?>
          <textarea id="<?= field.id ?>" name="<?= field.id ?>" 
                    placeholder="詳細なコメントをお聞かせください..." required></textarea>
          
        <? } else if (field.type === 'text') { ?>
          <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" 
                 placeholder="回答を入力してください" required 
                 style="width: 100%; padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-top: 12px;">
          
        <? } else { ?>
          <!-- 未知のフィールドタイプの場合はテキスト入力として表示 -->
          <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" required
                 style="width: 100%; padding: 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-top: 12px;">
        <? } ?>
      </div>
    <? } ?>
    
    <!-- ボタン -->
    <div class="button-container">
      <button type="submit" id="submitBtn">アンケートを送信</button>
      <button type="button" id="resetBtn">リセット</button>
    </div>
  </form>

  <!-- ローディング表示 -->
  <div id="loading" class="loading">
    <p>送信中...</p>
  </div>

  <!-- 結果表示エリア -->
  <div id="resultArea"></div>
</div>

<script>
// 星評価のテキスト更新
function updateRatingText(fieldId, value) {
  const ratingTexts = {
    1: 'とても悪い',
    2: '悪い',
    3: '普通',
    4: '良い',
    5: 'とても良い'
  };
  
  const textElement = document.getElementById('ratingText_' + fieldId);
  if (textElement) {
    textElement.textContent = ratingTexts[value] || '評価を選択してください';
  }
}

// フォーム送信処理
document.getElementById('surveyForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // 送信ボタンを無効化
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const loading = document.getElementById('loading');
  const resultArea = document.getElementById('resultArea');
  
  submitBtn.disabled = true;
  resetBtn.disabled = true;
  loading.classList.add('show');
  resultArea.innerHTML = '';
  
  // フォームデータを収集
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  // GASに送信
  google.script.run
    .withSuccessHandler(function(result) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      if (result.success) {
        resultArea.innerHTML = `
          <div class="success">
            <strong>送信完了！</strong><br>
            ${result.message}
          </div>
        `;
        
        // 3秒後にフォームをリセット
        setTimeout(() => {
          document.getElementById('surveyForm').reset();
          resultArea.innerHTML = '';
          // 星評価テキストをリセット
          document.querySelectorAll('[id^="ratingText_"]').forEach(el => {
            el.textContent = '評価を選択してください';
          });
        }, 3000);
        
      } else {
        resultArea.innerHTML = `
          <div class="error">
            <strong>エラーが発生しました</strong><br>
            ${result.message}
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      resultArea.innerHTML = `
        <div class="error">
          <strong>エラーが発生しました</strong><br>
          ${error.message || '不明なエラーが発生しました'}
        </div>
      `;
    })
    .submitSurveyResult(data);
});

// リセット処理
document.getElementById('resetBtn').addEventListener('click', function() {
  if (confirm('入力をリセットしてもよろしいですか？')) {
    document.getElementById('surveyForm').reset();
    document.getElementById('resultArea').innerHTML = '';
    // 星評価テキストをリセット
    document.querySelectorAll('[id^="ratingText_"]').forEach(el => {
      el.textContent = '評価を選択してください';
    });
  }
});

// 星評価の変更監視
document.addEventListener('change', function(e) {
  if (e.target.matches('input[type="radio"]')) {
    const fieldId = e.target.name;
    const value = e.target.value;
    updateRatingText(fieldId, value);
  }
});

// ページ読み込み時の処理
document.addEventListener('DOMContentLoaded', function() {
  // フォームの初期化
  console.log('カスタムアンケートフォームが読み込まれました');
  console.log('アンケートタイプ:', '<?= surveyType ?>');
  console.log('UID:', '<?= uid ?>');
  console.log('Method:', '<?= method ?>');
  console.log('Session:', '<?= session ?>');
});
</script>

</body>
</html>
