<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title><?= surveyConfig.name ?></title>
<style>
  /* 基本レイアウト */
  body   { font-family: sans-serif; margin: 24px; line-height: 1.6; }
  h2     { margin-bottom: 8px; }
  form   { max-width: 600px; }
  .item  { margin: 18px 0; }

  /* 項目ラベル（太字） */
  .item label { font-weight: bold; display: block; margin-bottom: 4px; }

  /* 説明文を細く小さく */
  .item label .desc{
    font-weight: normal;
    font-size: 0.85em;
    color: #666;
    line-height: 1.4;
    display: block;
    margin-top: 2px;
  }

  /* スライダー */
  input[type="range"]{ width: 100%; max-width: 480px; }

  /* テキスト入力 */
  input[type="text"], textarea { 
    width: 100%; 
    padding: 8px; 
    border: 1px solid #ddd; 
    border-radius: 4px; 
    font-size: 14px; 
  }
  
  textarea { 
    min-height: 100px; 
    resize: vertical; 
  }

  /* リッカート尺度 */
  .likert-scale {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
  }
  
  .likert-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    font-size: 0.85em;
  }
  
  .likert-option input[type="radio"] {
    margin-bottom: 4px;
  }

  /* 星評価 */
  .rating {
    display: flex;
    gap: 4px;
    margin-top: 8px;
  }
  
  .rating input[type="radio"] {
    display: none;
  }
  
  .rating label {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
  }
  
  .rating input[type="radio"]:checked ~ label,
  .rating label:hover,
  .rating label:hover ~ label {
    color: #ffd700;
  }

  /* アンカー（小さい↔大きい 等）表示 */
  .anchors{
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    margin-top: 2px;
    color: #555;
  }

  /* ボタン類 */
  button{ 
    padding: 8px 16px; 
    font-size: 1em; 
    margin-right: 12px; 
    cursor: pointer; 
    border: none;
    border-radius: 4px;
  }
  
  #submitBtn{ 
    background: #3498db; 
    color: #fff; 
  }
  
  #submitBtn:hover{ 
    background: #2980b9; 
  }
  
  #resetBtn{ 
    background: #e74c3c; 
    color: #fff; 
  }
  
  #resetBtn:hover{ 
    background: #c0392b; 
  }
  
  button:disabled{ 
    opacity: 0.6; 
    cursor: not-allowed; 
  }

  /* 注記・文献 */
  .note{ font-size: 0.85em; color: #555; margin-top: 28px; }
  
  /* ローディング表示 */
  .loading{ display: none; text-align: center; margin: 20px 0; }
  .loading.show{ display: block; }
  
  /* エラー表示 */
  .error{ color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 4px; margin: 10px 0; }
  
  /* 成功表示 */
  .success{ color: #27ae60; background: #f0f9f0; padding: 10px; border-radius: 4px; margin: 10px 0; }
  
  /* 実験情報 */
  .experiment-info {
    background: #f8f9fa; 
    padding: 10px; 
    border-radius: 4px; 
    margin-bottom: 20px; 
    font-size: 0.9em;
  }
</style>
</head>
<body>

<h2><?= surveyConfig.name ?></h2>

<!-- 実験パラメータ表示 -->
<div class="experiment-info">
  <strong>実験情報:</strong><br>
  UID: <?= uid ?><br>
  Method: <?= method ?><br>
  Session: <?= session ?>
</div>

<form id="surveyForm">
  <!-- 実験パラメータを隠しフィールドで保持 -->
  <input type="hidden" name="uid" value="<?= uid ?>">
  <input type="hidden" name="method" value="<?= method ?>">
  <input type="hidden" name="session" value="<?= session ?>">
  <input type="hidden" name="surveyType" value="<?= surveyType ?>">
  
  <!-- 動的にフィールドを生成 -->
  <? for (let field of surveyConfig.fields) { ?>
    <div class="item">
      <label for="<?= field.id ?>">
        <?= field.label ?>
        <? if (field.desc) { ?>
          <span class="desc"><?= field.desc ?></span>
        <? } ?>
      </label>
      
      <? if (field.type === 'range') { ?>
        <input type="range" id="<?= field.id ?>" name="<?= field.id ?>" 
               min="0" max="100" value="50" required>
        <? if (surveyConfig.anchors && surveyConfig.anchors[field.id]) { ?>
          <div class="anchors">
            <span><?= surveyConfig.anchors[field.id][0] ?></span>
            <span><?= surveyConfig.anchors[field.id][1] ?></span>
          </div>
        <? } ?>
        
      <? } else if (field.type === 'text') { ?>
        <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" required>
        
      <? } else if (field.type === 'textarea') { ?>
        <textarea id="<?= field.id ?>" name="<?= field.id ?>" required></textarea>
        
      <? } else if (field.type === 'likert') { ?>
        <div class="likert-scale">
          <? for (let i = 0; i < surveyConfig.likertOptions.length; i++) { ?>
            <div class="likert-option">
              <input type="radio" id="<?= field.id ?>_<?= i ?>" 
                     name="<?= field.id ?>" value="<?= i ?>" required>
              <label for="<?= field.id ?>_<?= i ?>"><?= surveyConfig.likertOptions[i] ?></label>
            </div>
          <? } ?>
        </div>
        
      <? } else if (field.type === 'rating') { ?>
        <div class="rating">
          <? for (let i = 5; i >= 1; i--) { ?>
            <input type="radio" id="<?= field.id ?>_<?= i ?>" 
                   name="<?= field.id ?>" value="<?= i ?>" required>
            <label for="<?= field.id ?>_<?= i ?>">★</label>
          <? } ?>
        </div>
        
      <? } else { ?>
        <!-- 未知のフィールドタイプの場合はテキスト入力として表示 -->
        <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" required>
      <? } ?>
    </div>
  <? } ?>
  
  <!-- ボタン -->
  <button type="submit" id="submitBtn">アンケートを送信</button>
  <button type="button" id="resetBtn">リセット</button>
</form>

<!-- ローディング表示 -->
<div id="loading" class="loading">
  <p>送信中...</p>
</div>

<!-- 結果表示エリア -->
<div id="resultArea"></div>

<script>
// フォーム送信処理
document.getElementById('surveyForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // 送信ボタンを無効化
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const loading = document.getElementById('loading');
  const resultArea = document.getElementById('resultArea');
  
  submitBtn.disabled = true;
  resetBtn.disabled = true;
  loading.classList.add('show');
  resultArea.innerHTML = '';
  
  // フォームデータを収集
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  // GASに送信
  google.script.run
    .withSuccessHandler(function(result) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      if (result.success) {
        resultArea.innerHTML = `
          <div class="success">
            <strong>送信完了！</strong><br>
            ${result.message}
          </div>
        `;
        
        // 3秒後にフォームをリセット
        setTimeout(() => {
          document.getElementById('surveyForm').reset();
          resultArea.innerHTML = '';
        }, 3000);
        
      } else {
        resultArea.innerHTML = `
          <div class="error">
            <strong>エラーが発生しました</strong><br>
            ${result.message}
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      resultArea.innerHTML = `
        <div class="error">
          <strong>エラーが発生しました</strong><br>
          ${error.message || '不明なエラーが発生しました'}
        </div>
      `;
    })
    .submitSurveyResult(data);
});

// リセット処理
document.getElementById('resetBtn').addEventListener('click', function() {
  if (confirm('入力をリセットしてもよろしいですか？')) {
    document.getElementById('surveyForm').reset();
    document.getElementById('resultArea').innerHTML = '';
  }
});

// ページ読み込み時の処理
document.addEventListener('DOMContentLoaded', function() {
  // フォームの初期化
  console.log('デフォルトアンケートフォームが読み込まれました');
  console.log('アンケートタイプ:', '<?= surveyType ?>');
  console.log('UID:', '<?= uid ?>');
  console.log('Method:', '<?= method ?>');
  console.log('Session:', '<?= session ?>');
});
</script>

</body>
</html>
