<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title><?= surveyConfig.name ?></title>
<style>
  /* 基本レイアウト */
  body   { font-family: sans-serif; margin: 24px; line-height: 1.6; }
  h2     { margin-bottom: 8px; }
  form   { max-width: 800px; }
  .item  { margin: 24px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }

  /* 項目ラベル（太字） */
  .item label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 1.1em; }

  /* 説明文を細く小さく */
  .item label .desc{
    font-weight: normal;
    font-size: 0.9em;
    color: #666;
    line-height: 1.4;
    display: block;
    margin-top: 4px;
  }

  /* リッカート尺度 */
  .likert-scale {
    display: flex;
    justify-content: space-between;
    margin-top: 16px;
    background: white;
    padding: 16px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .likert-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    flex: 1;
    margin: 0 4px;
  }
  
  .likert-option input[type="radio"] {
    display: none;
  }
  
  .likert-option label {
    padding: 12px 8px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85em;
    line-height: 1.3;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
  }
  
  .likert-option input[type="radio"]:checked + label {
    border-color: #3498db;
    background: #3498db;
    color: white;
    transform: scale(1.05);
  }
  
  .likert-option label:hover {
    border-color: #3498db;
    background: #f8f9fa;
  }

  /* テキスト入力 */
  input[type="text"], textarea { 
    width: 100%; 
    padding: 12px; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
    font-size: 14px; 
    margin-top: 8px;
  }
  
  textarea { 
    min-height: 120px; 
    resize: vertical; 
  }

  /* ボタン類 */
  button{ 
    padding: 12px 24px; 
    font-size: 1em; 
    margin-right: 16px; 
    cursor: pointer; 
    border: none;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  
  #submitBtn{ 
    background: #27ae60; 
    color: #fff; 
  }
  
  #submitBtn:hover{ 
    background: #229954; 
    transform: translateY(-1px);
  }
  
  #resetBtn{ 
    background: #e74c3c; 
    color: #fff; 
  }
  
  #resetBtn:hover{ 
    background: #c0392b; 
    transform: translateY(-1px);
  }
  
  button:disabled{ 
    opacity: 0.6; 
    cursor: not-allowed; 
    transform: none !important;
  }

  /* 注記・文献 */
  .note{ font-size: 0.85em; color: #555; margin-top: 28px; }
  
  /* ローディング表示 */
  .loading{ display: none; text-align: center; margin: 20px 0; }
  .loading.show{ display: block; }
  
  /* エラー表示 */
  .error{ color: #e74c3c; background: #fdf2f2; padding: 12px; border-radius: 6px; margin: 12px 0; }
  
  /* 成功表示 */
  .success{ color: #27ae60; background: #f0f9f0; padding: 12px; border-radius: 6px; margin: 12px 0; }
  
  /* 実験情報 */
  .experiment-info {
    background: #e8f4fd; 
    padding: 16px; 
    border-radius: 8px; 
    margin-bottom: 24px; 
    font-size: 0.9em;
    border-left: 4px solid #3498db;
  }
  
  /* 進捗表示 */
  .progress {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
  }
  
  .progress-fill {
    height: 100%;
    background: #3498db;
    transition: width 0.3s ease;
  }
</style>
</head>
<body>

<h2><?= surveyConfig.name ?></h2>

<!-- 実験パラメータ表示 -->
<div class="experiment-info">
  <strong>実験情報:</strong><br>
  UID: <?= uid ?><br>
  Method: <?= method ?><br>
  Session: <?= session ?>
</div>

<!-- 進捗表示 -->
<div class="progress">
  <div>進捗: <span id="progressText">0</span> / <?= surveyConfig.fields.length ?></div>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
</div>

<form id="surveyForm">
  <!-- 実験パラメータを隠しフィールドで保持 -->
  <input type="hidden" name="uid" value="<?= uid ?>">
  <input type="hidden" name="method" value="<?= method ?>">
  <input type="hidden" name="session" value="<?= session ?>">
  <input type="hidden" name="surveyType" value="<?= surveyType ?>">
  
  <!-- 動的にフィールドを生成 -->
  <? for (let i = 0; i < surveyConfig.fields.length; i++) { ?>
    <? const field = surveyConfig.fields[i]; ?>
    <div class="item" data-field-index="<?= i ?>">
      <label for="<?= field.id ?>">
        <?= i + 1 ?>. <?= field.label ?>
        <? if (field.desc) { ?>
          <span class="desc"><?= field.desc ?></span>
        <? } ?>
      </label>
      
      <? if (field.type === 'likert') { ?>
        <div class="likert-scale">
          <? for (let j = 0; j < surveyConfig.likertOptions.length; j++) { ?>
            <div class="likert-option">
              <input type="radio" id="<?= field.id ?>_<?= j ?>" 
                     name="<?= field.id ?>" value="<?= j ?>" required>
              <label for="<?= field.id ?>_<?= j ?>"><?= surveyConfig.likertOptions[j] ?></label>
            </div>
          <? } ?>
        </div>
        
      <? } else if (field.type === 'text') { ?>
        <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" 
               placeholder="回答を入力してください" required>
        
      <? } else if (field.type === 'textarea') { ?>
        <textarea id="<?= field.id ?>" name="<?= field.id ?>" 
                  placeholder="詳細な回答を入力してください" required></textarea>
        
      <? } else { ?>
        <!-- 未知のフィールドタイプの場合はテキスト入力として表示 -->
        <input type="text" id="<?= field.id ?>" name="<?= field.id ?>" required>
      <? } ?>
    </div>
  <? } ?>
  
  <!-- ボタン -->
  <button type="submit" id="submitBtn">アンケートを送信</button>
  <button type="button" id="resetBtn">リセット</button>
</form>

<!-- ローディング表示 -->
<div id="loading" class="loading">
  <p>送信中...</p>
</div>

<!-- 結果表示エリア -->
<div id="resultArea"></div>

<script>
// 進捗更新関数
function updateProgress() {
  const fields = document.querySelectorAll('.item');
  const answeredFields = document.querySelectorAll('.item input:checked, .item input[type="text"]:not([value=""]), .item textarea:not([value=""])');
  
  const progress = Math.round((answeredFields.length / fields.length) * 100);
  const progressText = document.getElementById('progressText');
  const progressFill = document.getElementById('progressFill');
  
  progressText.textContent = answeredFields.length;
  progressFill.style.width = progress + '%';
  
  // 進捗に応じて色を変更
  if (progress >= 100) {
    progressFill.style.background = '#27ae60';
  } else if (progress >= 50) {
    progressFill.style.background = '#f39c12';
  } else {
    progressFill.style.background = '#3498db';
  }
}

// フォーム送信処理
document.getElementById('surveyForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // 送信ボタンを無効化
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const loading = document.getElementById('loading');
  const resultArea = document.getElementById('resultArea');
  
  submitBtn.disabled = true;
  resetBtn.disabled = true;
  loading.classList.add('show');
  resultArea.innerHTML = '';
  
  // フォームデータを収集
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  // GASに送信
  google.script.run
    .withSuccessHandler(function(result) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      if (result.success) {
        resultArea.innerHTML = `
          <div class="success">
            <strong>送信完了！</strong><br>
            ${result.message}
          </div>
        `;
        
        // 3秒後にフォームをリセット
        setTimeout(() => {
          document.getElementById('surveyForm').reset();
          resultArea.innerHTML = '';
          updateProgress();
        }, 3000);
        
      } else {
        resultArea.innerHTML = `
          <div class="error">
            <strong>エラーが発生しました</strong><br>
            ${result.message}
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      loading.classList.remove('show');
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      
      resultArea.innerHTML = `
        <div class="error">
          <strong>エラーが発生しました</strong><br>
          ${error.message || '不明なエラーが発生しました'}
        </div>
      `;
    })
    .submitSurveyResult(data);
});

// リセット処理
document.getElementById('resetBtn').addEventListener('click', function() {
  if (confirm('入力をリセットしてもよろしいですか？')) {
    document.getElementById('surveyForm').reset();
    document.getElementById('resultArea').innerHTML = '';
    updateProgress();
  }
});

// 進捗監視
document.addEventListener('change', function(e) {
  if (e.target.matches('input[type="radio"], input[type="text"], textarea')) {
    updateProgress();
  }
});

// ページ読み込み時の処理
document.addEventListener('DOMContentLoaded', function() {
  // フォームの初期化
  console.log('リッカート尺度アンケートフォームが読み込まれました');
  console.log('アンケートタイプ:', '<?= surveyType ?>');
  console.log('UID:', '<?= uid ?>');
  console.log('Method:', '<?= method ?>');
  console.log('Session:', '<?= session ?>');
  
  // 初期進捗を設定
  updateProgress();
});
</script>

</body>
</html>
